# Intro

提升硬件性能主要有三类方法:

第一类方法是将更多的精力用于发掘各种并行性;

第二类方法是引入新的存储层次来缓解访存速度和存储容量之间的矛盾;

第三类方法则是通过定制化的方法来提升硬件处理领域相关应用的性能。


## 并行性发掘

指令级并行, 单指令多数据并行(SIMD), 线程级并行(thread), 请求级并行(request)

指令级并行: 流水线(时间), 多发射(空间), 同时多线程(时间空间), 超长指令字(时间空间)

单指令多数据并行: 空间并行

线程级并行: 不同执行单元的指令流互相独立, 以同步或异步处理数据

请求级并行: 并行粒度更粗, 更加依赖于程序员

## 循环优化的数学抽象

N重循环嵌套的上下界表达式通常是仿射表达式

迭代空间抽象: N重嵌套循环 -> N维迭代空间

语句实例抽象: N重嵌套循环的每个静态语句和循环迭代变量的组合抽象成一个动态语句实例

数据空间抽象: M维数组抽象为一个M维的数据空间

处理器空间抽象: 将可以并行工作的计算的单元进行抽象

依赖关系抽象: 对数据空间的访问关系可以细分为读访问和写访问, 动态语句实例之间的依赖关系就是程序对数据空间的读写顺序约束

调度抽象: 将一个动态语句实例映射到一个多维的执行时间

多面体模型把循环优化问题转化为多维空间和空间之间的仿射映射, 使得我们使用标准数学技术(线性规划)来解决循环并行和局部性优化问题

### 迭代空间

N重循环的迭代空间是一个满足循环约束的N维子空间, 关键在于确定每重循环的上界下界, 需要经过等价变换和保守处理

#### Presburger
Preburger表示有利于实现自动推导, 描述线性约束时使用rem, floordiv, ceildiv, max, min等

在仿射约束的基础上增加上述特殊运算符得到的表达式是近似**仿射表达式**

多面体模型要求循环索引变量的上界下界表达式必须是符号常量或外层循环索引变量构成的近似仿射表达式

### 数据空间及其访问函数

多面体模型对数据空间的访问函数要求: 必须是由常量和外层索引循环变量构成的近似仿射表达式

仿射访问函数提供了从迭代空间到数据空间的一个映射关系

### 调度抽象

迭代空间可能没有规定每个迭代向量之间的遍历顺序, 实际的遍历顺序(动态语句实例的执行顺序)是由调度抽象描述

每种可行的执行顺序都是一种调度

任意不破坏数据依赖的调度变换都是合法的, 但不同的执行顺序的性能都是不同的

## 多面体在编译器中的应用

深度学习领域的编译器通常以计算图级别的优化, 算子级别的优化和指令级别的传统优化

多面体模型的编译抽象层级高于指令级并行, 又低于划分计算图级别

多面体模型解决的是通过线程级并行, 向量化方式来挖掘程序的数据并行

## 多面体模型的编译流程

依赖分析: 循环优化过程中必须保持读后写依赖, 写后写依赖, 写后读依赖; 确定两个地址访问是否存在依赖是别名分析依赖; 相关性测试是确定循环嵌套中对同一个数组的两个或多个下标引用之间是否存在相关性的一种方法

数据依赖判断问题可以转化为一个整数线性规划问题

循环变换: 是多面体优化的核心, 是实现并行性和局部性发掘的核心手段

循环交换, 循环反转, 循环倾斜, 循环展开, 循环分布, 循环偏移

并行性优化: 

任务映射: 循环和处理器空间的关系

局部优化: 数据依赖和数据局部性又紧密的关联

代码生成: 
